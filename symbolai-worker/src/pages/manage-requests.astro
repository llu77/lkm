---
import MainLayout from '@/layouts/MainLayout.astro';

// Check authentication
const cookieHeader = Astro.request.headers.get('Cookie');
if (!cookieHeader?.includes('session=')) {
  return Astro.redirect('/auth/login');
}
---

<MainLayout title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª - SymbolAI">
  <div class="space-y-6">
    <div>
      <h1 class="text-3xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
      <p class="text-muted-foreground mt-2">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid gap-4 md:grid-cols-3">
      <div class="rounded-lg border bg-card p-4">
        <h3 class="text-sm font-medium text-muted-foreground">Ù…Ø¹Ù„Ù‚Ø©</h3>
        <p class="text-2xl font-bold mt-2 text-yellow-600" id="pending-count">0</p>
      </div>
      <div class="rounded-lg border bg-card p-4">
        <h3 class="text-sm font-medium text-muted-foreground">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</h3>
        <p class="text-2xl font-bold mt-2 text-green-600" id="approved-count">0</p>
      </div>
      <div class="rounded-lg border bg-card p-4">
        <h3 class="text-sm font-medium text-muted-foreground">Ù…Ø±ÙÙˆØ¶Ø©</h3>
        <p class="text-2xl font-bold mt-2 text-red-600" id="rejected-count">0</p>
      </div>
    </div>

    <!-- Filters -->
    <div class="rounded-lg border bg-card p-4">
      <div class="grid gap-4 md:grid-cols-3">
        <div>
          <label class="block text-sm font-medium mb-2">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="status-filter" class="w-full rounded-md border px-3 py-2">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option>
            <option value="approved">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</option>
            <option value="rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
          <select id="type-filter" class="w-full rounded-md border px-3 py-2">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            <option value="Ø³Ù„ÙØ©">Ø³Ù„ÙØ©</option>
            <option value="Ø¥Ø¬Ø§Ø²Ø©">Ø¥Ø¬Ø§Ø²Ø©</option>
            <option value="ØµØ±Ù Ù…ØªØ£Ø®Ø±Ø§Øª">ØµØ±Ù Ù…ØªØ£Ø®Ø±Ø§Øª</option>
            <option value="Ø§Ø³ØªØ¦Ø°Ø§Ù†">Ø§Ø³ØªØ¦Ø°Ø§Ù†</option>
            <option value="Ù…Ø®Ø§Ù„ÙØ©">Ù…Ø®Ø§Ù„ÙØ©</option>
            <option value="Ø§Ø³ØªÙ‚Ø§Ù„Ø©">Ø§Ø³ØªÙ‚Ø§Ù„Ø©</option>
          </select>
        </div>
        <div class="flex items-end">
          <button
            id="apply-filter-btn"
            class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors"
          >
            ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
          </button>
        </div>
      </div>
    </div>

    <!-- Requests Table -->
    <div class="rounded-lg border bg-card p-6">
      <h3 class="text-xl font-semibold mb-4">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b">
              <th class="text-right p-3 font-medium">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th class="text-right p-3 font-medium">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</th>
              <th class="text-right p-3 font-medium">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</th>
              <th class="text-right p-3 font-medium">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th class="text-right p-3 font-medium">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="requests-table-body">
            <tr>
              <td colspan="5" class="text-center p-8 text-muted-foreground">
                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Response Dialog -->
  <div id="response-dialog" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-4">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨</h2>

      <div id="request-details" class="rounded-lg bg-gray-50 p-4 mb-4 space-y-2"></div>

      <form id="response-form" class="space-y-4">
        <input type="hidden" id="request-id" />

        <div>
          <label class="block text-sm font-medium mb-2">Ø§Ù„Ù‚Ø±Ø§Ø± *</label>
          <div class="space-y-2">
            <label class="flex items-center gap-2">
              <input type="radio" name="decision" value="approved" required class="rounded" />
              <span>Ù…ÙˆØ§ÙÙ‚Ø©</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="decision" value="rejected" required class="rounded" />
              <span>Ø±ÙØ¶</span>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Ø§Ù„Ø±Ø¯ *</label>
          <textarea
            id="admin-response"
            required
            rows="4"
            placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨..."
            class="w-full rounded-md border px-3 py-2"
          ></textarea>
        </div>

        <div class="rounded-lg bg-blue-50 border border-blue-200 p-3">
          <p class="text-sm text-blue-800">ğŸ’¡ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø±Ø¯</p>
        </div>

        <div class="flex gap-3 justify-end pt-4">
          <button
            type="button"
            id="cancel-response-btn"
            class="px-4 py-2 border rounded-md hover:bg-gray-50"
          >
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button
            type="submit"
            id="submit-response-btn"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    interface Request {
      id: string;
      employee_name: string;
      request_type: string;
      request_date: string;
      status: string;
      advance_amount?: number;
      vacation_date?: string;
      dues_amount?: number;
      permission_date?: string;
      violation_date?: string;
      violation_description?: string;
      resignation_date?: string;
      resignation_reason?: string;
      admin_response?: string;
    }

    let allRequests: Request[] = [];
    let currentRequest: Request | null = null;

    function formatDate(dateStr: string): string {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('ar-EG');
    }

    function formatCurrency(amount: number): string {
      return new Intl.NumberFormat('ar-EG').format(amount) + ' Ø¬.Ù…';
    }

    function getStatusBadge(status: string): string {
      const badges: { [key: string]: string } = {
        'pending': '<span class="px-3 py-1 rounded text-sm bg-yellow-100 text-yellow-800">â³ Ù…Ø¹Ù„Ù‚Ø©</span>',
        'approved': '<span class="px-3 py-1 rounded text-sm bg-green-100 text-green-800">âœ“ Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</span>',
        'rejected': '<span class="px-3 py-1 rounded text-sm bg-red-100 text-red-800">âœ— Ù…Ø±ÙÙˆØ¶Ø©</span>'
      };
      return badges[status] || status;
    }

    async function loadRequests() {
      const statusFilter = (document.getElementById('status-filter') as HTMLSelectElement).value;

      try {
        const response = await fetch(`/api/requests/all?status=${statusFilter}`);
        const data = await response.json();

        if (data.success) {
          allRequests = data.requests;
          updateStats(data.stats);
          filterAndRenderRequests();
        } else {
          alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
      } catch (error) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
      }
    }

    function updateStats(stats: { pending: number; approved: number; rejected: number }) {
      document.getElementById('pending-count')!.textContent = stats.pending.toString();
      document.getElementById('approved-count')!.textContent = stats.approved.toString();
      document.getElementById('rejected-count')!.textContent = stats.rejected.toString();
    }

    function filterAndRenderRequests() {
      const typeFilter = (document.getElementById('type-filter') as HTMLSelectElement).value;

      let filtered = allRequests;

      if (typeFilter !== 'all') {
        filtered = filtered.filter(r => r.request_type === typeFilter);
      }

      renderRequests(filtered);
    }

    function renderRequests(requests: Request[]) {
      const tbody = document.getElementById('requests-table-body')!;

      if (requests.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center p-8 text-muted-foreground">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = requests.map(req => `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3 font-medium">${req.employee_name}</td>
          <td class="p-3">${req.request_type}</td>
          <td class="p-3">${formatDate(req.request_date)}</td>
          <td class="p-3">${getStatusBadge(req.status)}</td>
          <td class="p-3">
            <button
              onclick="viewRequest('${req.id}')"
              class="text-blue-600 hover:text-blue-800 text-sm font-medium"
            >
              ${req.status === 'pending' ? 'Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨' : 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„'}
            </button>
          </td>
        </tr>
      `).join('');
    }

    function getRequestDetails(request: Request): string {
      const details: string[] = [
        `<div><span class="font-medium">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</span> ${request.employee_name}</div>`,
        `<div><span class="font-medium">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨:</span> ${request.request_type}</div>`,
        `<div><span class="font-medium">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…:</span> ${formatDate(request.request_date)}</div>`
      ];

      // Add type-specific details
      if (request.request_type === 'Ø³Ù„ÙØ©' && request.advance_amount) {
        details.push(`<div><span class="font-medium">Ø§Ù„Ù…Ø¨Ù„Øº:</span> ${formatCurrency(request.advance_amount)}</div>`);
      }

      if (request.request_type === 'Ø¥Ø¬Ø§Ø²Ø©' && request.vacation_date) {
        details.push(`<div><span class="font-medium">Ø§Ù„ÙØªØ±Ø©:</span> ${request.vacation_date}</div>`);
      }

      if (request.request_type === 'ØµØ±Ù Ù…ØªØ£Ø®Ø±Ø§Øª' && request.dues_amount) {
        details.push(`<div><span class="font-medium">Ø§Ù„Ù…Ø¨Ù„Øº:</span> ${formatCurrency(request.dues_amount)}</div>`);
      }

      if (request.request_type === 'Ø§Ø³ØªØ¦Ø°Ø§Ù†' && request.permission_date) {
        details.push(`<div><span class="font-medium">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª:</span> ${request.permission_date}</div>`);
      }

      if (request.request_type === 'Ù…Ø®Ø§Ù„ÙØ©') {
        if (request.violation_date) {
          details.push(`<div><span class="font-medium">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${formatDate(request.violation_date)}</div>`);
        }
        if (request.violation_description) {
          details.push(`<div><span class="font-medium">Ø§Ù„ÙˆØµÙ:</span> ${request.violation_description}</div>`);
        }
      }

      if (request.request_type === 'Ø§Ø³ØªÙ‚Ø§Ù„Ø©') {
        if (request.resignation_date) {
          details.push(`<div><span class="font-medium">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ‚Ø§Ù„Ø©:</span> ${formatDate(request.resignation_date)}</div>`);
        }
        if (request.resignation_reason) {
          details.push(`<div><span class="font-medium">Ø§Ù„Ø³Ø¨Ø¨:</span> ${request.resignation_reason}</div>`);
        }
      }

      // Add response if exists
      if (request.admin_response) {
        details.push(`<div class="mt-2 pt-2 border-t"><span class="font-medium">Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚:</span> ${request.admin_response}</div>`);
      }

      return details.join('');
    }

    (window as any).viewRequest = (id: string) => {
      const request = allRequests.find(r => r.id === id);
      if (!request) return;

      currentRequest = request;
      document.getElementById('request-id')!.setAttribute('value', id);
      document.getElementById('request-details')!.innerHTML = getRequestDetails(request);

      // If already responded, disable form
      if (request.status !== 'pending') {
        (document.getElementById('response-form') as HTMLFormElement).querySelectorAll('input, textarea, button[type="submit"]').forEach(el => {
          (el as HTMLInputElement).disabled = true;
        });
      }

      document.getElementById('response-dialog')!.classList.remove('hidden');
    };

    // Dialog controls
    const responseDialog = document.getElementById('response-dialog')!;
    const responseForm = document.getElementById('response-form') as HTMLFormElement;
    const cancelResponseBtn = document.getElementById('cancel-response-btn')!;

    cancelResponseBtn.addEventListener('click', () => {
      responseDialog.classList.add('hidden');
      responseForm.reset();
      currentRequest = null;
    });

    // Submit response
    responseForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submit-response-btn') as HTMLButtonElement;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

      const requestId = (document.getElementById('request-id') as HTMLInputElement).value;
      const decision = (document.querySelector('input[name="decision"]:checked') as HTMLInputElement)?.value;
      const adminResponse = (document.getElementById('admin-response') as HTMLTextAreaElement).value;

      try {
        const response = await fetch('/api/requests/respond', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: requestId,
            status: decision,
            adminResponse
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
          responseDialog.classList.add('hidden');
          responseForm.reset();
          currentRequest = null;
          loadRequests();
        } else {
          alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
      } catch (error) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯';
      }
    });

    // Filters
    document.getElementById('status-filter')?.addEventListener('change', loadRequests);
    document.getElementById('apply-filter-btn')?.addEventListener('click', filterAndRenderRequests);

    // Initial load
    loadRequests();
  </script>
</MainLayout>
