# Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„ÙØ±ÙˆØ¹ - SymbolAI

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

ØªÙ… ØªÙ†ÙÙŠØ° Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (RBAC) Ù…Ø¹ Ø¹Ø²Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙˆØ¹.

## ğŸ‘¥ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©

### 1. Ø§Ù„Ø£Ø¯Ù…Ù† (Admin)
**Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:**
- âœ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹
- âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù)
- âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹
- âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
- âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (CRUD ÙƒØ§Ù…Ù„)

**Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**
- Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù†Ø¸Ø§Ù…
- Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª

### 2. Ù…Ø´Ø±Ù Ø§Ù„ÙØ±Ø¹ (Supervisor)
**Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:**
- âœ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ù„ÙØ±Ø¹Ù‡ ÙÙ‚Ø·)
- âœ… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
- âœ… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡Ø§
- âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
- âœ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´ÙˆÙ Ø§Ù„Ø±ÙˆØ§ØªØ¨
- âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª
- âœ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ù„ÙØ±Ø¹Ù‡ ÙÙ‚Ø·)
- âŒ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£Ø®Ø±Ù‰

**Ø§Ù„Ø¹Ø²Ù„:**
- Ù…Ø±ØªØ¨Ø· Ø¨Ù€ `branch_id` ÙˆØ§Ø­Ø¯
- Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§ØªÙ‡ Ù…Ø­ØµÙˆØ±Ø© ÙÙŠ ÙØ±Ø¹Ù‡

### 3. Ø§Ù„Ø´Ø±ÙŠÙƒ (Partner)
**Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:**
- âœ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ù„ÙØ±Ø¹Ù‡ ÙÙ‚Ø·)
- âŒ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
- âŒ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£Ø®Ø±Ù‰

**Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**
- Ù„Ù„Ø´Ø±ÙƒØ§Ø¡ Ø§Ù„Ø°ÙŠÙ† ÙŠØ±ÙŠØ¯ÙˆÙ† Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø¯Ø§Ø¡ ÙØ±Ø¹Ù‡Ù… ÙÙ‚Ø·

### 4. Ø§Ù„Ù…ÙˆØ¸Ù (Employee)
**Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:**
- âœ… Ø±ÙØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ø¥Ø¬Ø§Ø²Ø©ØŒ Ø³Ù„ÙØ©ØŒ Ø¥Ø°Ù†ØŒ Ø´ÙƒÙˆÙ‰ØŒ Ø§Ù‚ØªØ±Ø§Ø­)
- âœ… Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§ØªÙ‡
- âœ… Ù…Ø´Ø§Ù‡Ø¯Ø© Ù…ÙƒØ§ÙØ¢ØªÙ‡
- âŒ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
- âŒ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸ÙÙŠÙ† Ø¢Ø®Ø±ÙŠÙ†

## ğŸ—„ï¸ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

### Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

#### 1. `branches` - Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ±ÙˆØ¹
```sql
- id: Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±Ø¹
- name: Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
- name_ar: Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
- location: Ø§Ù„Ù…ÙˆÙ‚Ø¹
- phone: Ø§Ù„Ù‡Ø§ØªÙ
- manager_name: Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±
- is_active: Ù†Ø´Ø·/ØºÙŠØ± Ù†Ø´Ø·
- total_revenue: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
- total_expenses: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
- employee_count: Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
```

#### 2. `roles` - Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
```sql
- id: Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙˆØ±
- name: Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ± (admin, supervisor, partner, employee)
- name_ar: Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
- 16 ØµÙ„Ø§Ø­ÙŠØ© (can_*)
```

#### 3. `users_new` - Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ù‘Ø«
```sql
- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© + role_id + branch_id
```

#### 4. `audit_logs` - Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
```sql
- ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (create, update, delete, view)
- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙØ±Ø¹
- IP Address Ùˆ User Agent
```

### Views (Ø·Ø±Ù‚ Ø¹Ø±Ø¶ Ù…Ø­Ø³Ù‘Ù†Ø©)

#### `users_with_roles`
Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„ÙØ±Ø¹

#### `branch_statistics`
Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ„ ÙØ±Ø¹ (Ù…ÙˆØ¸ÙÙŠÙ†ØŒ Ø¥ÙŠØ±Ø§Ø¯Ø§ØªØŒ Ù…ØµØ±ÙˆÙØ§ØªØŒ Ø·Ù„Ø¨Ø§Øª)

## ğŸ” Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

### Ù…Ù„Ù `permissions.ts`

**Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**

```typescript
// 1. ØªØ­Ù…ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
loadUserPermissions(db, userId)

// 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø¹ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
requireAuthWithPermissions(kv, db, request)

// 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯ÙˆØ± Ø§Ù„Ø£Ø¯Ù…Ù†
requireAdminRole(kv, db, request)

// 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø´Ø±Ù Ø£Ùˆ Ø£Ø¯Ù…Ù†
requireSupervisorOrAdmin(kv, db, request)

// 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©
checkPermission(session, 'canAddRevenue')

// 6. ÙØ­Øµ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙØ±Ø¹
canAccessBranch(session, branchId)

// 7. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
getAllowedBranchIds(session) // null = Ø§Ù„ÙƒÙ„, [id] = ÙØ±Ø¹ ÙˆØ§Ø­Ø¯

// 8. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙØ±Ø¹ ÙÙŠ API
validateBranchAccess(session, requestedBranchId)

// 9. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ WHERE clause Ù„Ù„Ø¹Ø²Ù„
getBranchFilterSQL(session)
// Admin: '' (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø©)
// Supervisor: 'AND branch_id = ?' Ù…Ø¹ [branchId]

// 10. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
logAudit(db, session, action, entityType, entityId, details)
```

## ğŸ“§ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ

### Ù…Ù„Ù `email-error-handler.ts`

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**

1. **ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Error Classification)**
   - Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©)
   - Ø£Ø®Ø·Ø§Ø¡ API
   - Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©)
   - Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…

2. **Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Exponential Backoff**
   ```typescript
   retryWithBackoff(operation, config)
   // Ù…Ø­Ø§ÙˆÙ„Ø§Øª: 2s, 5s, 10s
   ```

3. **Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©**
   - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   - Ø¥Ù†Ø´Ø§Ø¡ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø±Ø¬Ø©
   - Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„ÙŠØ©/Ø§Ù„Ø­Ø±Ø¬Ø©

4. **ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ù†Ø¸Ø§Ù…**
   ```typescript
   checkEmailSystemHealth(env)
   // ÙŠÙØ­Øµ: API Key, Ø§Ù„ÙØ´Ù„ Ø§Ù„Ø£Ø®ÙŠØ±, Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
   ```

## ğŸ”Œ APIs Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

### Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹

| Endpoint | Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ | Ø§Ù„ÙˆØ¸ÙŠÙØ© |
|----------|--------------|---------|
| `GET /api/branches/list` | Any (Ù…Ø¹ Ø¹Ø²Ù„) | Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±ÙˆØ¹ |
| `POST /api/branches/create` | Admin | Ø¥Ù†Ø´Ø§Ø¡ ÙØ±Ø¹ |
| `POST /api/branches/update` | Admin | ØªØ­Ø¯ÙŠØ« ÙØ±Ø¹ |
| `GET /api/branches/stats` | Any (Ù…Ø¹ Ø¹Ø²Ù„) | Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ±Ø¹ |

### Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

| Endpoint | Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ | Ø§Ù„ÙˆØ¸ÙŠÙØ© |
|----------|--------------|---------|
| `GET /api/users/list` | Admin/Supervisor | Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† |
| `POST /api/users/create` | Admin | Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… |
| `POST /api/users/update` | Admin | ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªØ®Ø¯Ù… |

### Ø§Ù„Ø£Ø¯ÙˆØ§Ø±

| Endpoint | Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ | Ø§Ù„ÙˆØ¸ÙŠÙØ© |
|----------|--------------|---------|
| `GET /api/roles/list` | Any | Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± |

### ÙØ­Øµ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ

| Endpoint | Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ | Ø§Ù„ÙˆØ¸ÙŠÙØ© |
|----------|--------------|---------|
| `GET /api/email/health` | Admin | ÙØ­Øµ ØµØ­Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯ |

## ğŸ“ Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ API

```typescript
// Ù…Ø«Ø§Ù„: API Ù„Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯ Ù…Ø¹ Ø¹Ø²Ù„ Ø§Ù„ÙØ±Ø¹

import { requireAuthWithPermissions, requirePermission, validateBranchAccess, logAudit } from '@/lib/permissions';

export const POST: APIRoute = async ({ request, locals }) => {
  // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  const authResult = await requireAuthWithPermissions(
    locals.runtime.env.SESSIONS,
    locals.runtime.env.DB,
    request
  );

  if (authResult instanceof Response) {
    return authResult;
  }

  // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©
  const permissionError = requirePermission(authResult, 'canAddRevenue');
  if (permissionError) {
    return permissionError;
  }

  const { branchId, amount, description } = await request.json();

  // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙØ±Ø¹
  const branchAccessError = validateBranchAccess(authResult, branchId);
  if (branchAccessError) {
    return branchAccessError;
  }

  // 4. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  const revenueId = generateId();
  await locals.runtime.env.DB.prepare(`
    INSERT INTO revenues (id, branch_id, amount, description)
    VALUES (?, ?, ?, ?)
  `).bind(revenueId, branchId, amount, description).run();

  // 5. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
  await logAudit(
    locals.runtime.env.DB,
    authResult,
    'create',
    'revenue',
    revenueId,
    { branchId, amount },
    getClientIP(request)
  );

  return new Response(JSON.stringify({ success: true, id: revenueId }), {
    status: 201,
    headers: { 'Content-Type': 'application/json' }
  });
};
```

## ğŸš€ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„

### 1. ØªØ·Ø¨ÙŠÙ‚ Migration
```bash
cd symbolai-worker

# Local
wrangler d1 execute DB --local --file=./migrations/002_create_branches_and_roles.sql

# Production
wrangler d1 execute DB --remote --file=./migrations/002_create_branches_and_roles.sql
```

### 2. ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† (Ø¥Ø°Ø§ ÙˆØ¬Ø¯ÙˆØ§)
```sql
-- Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† users Ø¥Ù„Ù‰ users_new
INSERT INTO users_new (id, username, password, email, full_name, phone, role_id, branch_id, is_active, created_at)
SELECT
  id,
  username,
  password,
  email,
  full_name,
  phone,
  'role_admin' as role_id,  -- Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚
  NULL as branch_id,
  is_active,
  created_at
FROM users;

-- Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
DROP TABLE users;

-- Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©
ALTER TABLE users_new RENAME TO users;
```

### 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ±ÙˆØ¹
Ø§Ø³ØªØ®Ø¯Ù… `/api/branches/create` Ù„Ø¥Ø¶Ø§ÙØ© ÙØ±ÙˆØ¹Ùƒ

### 4. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ÙØ±ÙˆØ¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
Ø§Ø³ØªØ®Ø¯Ù… `/api/users/update` Ù„ØªØ¹ÙŠÙŠÙ† role_id Ùˆ branch_id

## ğŸ“Š Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

### Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: Ù…Ø´Ø±Ù ÙØ±Ø¹ ÙŠØ¯Ø®Ù„ Ø¥ÙŠØ±Ø§Ø¯
1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â†’ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ session Ù…Ø¹ `branchId = 'branch_cairo'`
2. ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
3. Ø¥Ø¯Ø®Ø§Ù„ Ø¥ÙŠØ±Ø§Ø¯ â†’ API ÙŠØªØ­Ù‚Ù‚ Ù…Ù† `canAddRevenue = true`
4. API ÙŠØªØ­Ù‚Ù‚ Ù…Ù† `branchId` Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ = `branch_cairo` âœ…
5. ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­

### Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: Ù…Ø´Ø±Ù ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ÙØ±Ø¹ Ø¢Ø®Ø±
1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â†’ `branchId = 'branch_cairo'`
2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª `branch_alex`
3. `validateBranchAccess()` â†’ ÙŠØ±Ø¬Ø¹ 403 Forbidden âŒ

### Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 3: Ø´Ø±ÙŠÙƒ ÙŠØ´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â†’ `branchId = 'branch_cairo'`, `canViewReports = true`
2. ÙØªØ­ Dashboard â†’ ÙŠØ±Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙØ±Ø¹Ù‡ ÙÙ‚Ø·
3. Ù„Ø§ ÙŠØ±Ù‰ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (frontend ÙŠØ®ÙÙŠÙ‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)

### Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 4: Ù…ÙˆØ¸Ù ÙŠØ±ÙØ¹ Ø·Ù„Ø¨
1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â†’ `canSubmitRequests = true`
2. ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
3. Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©
4. ÙŠØ±Ù‰ Ø·Ù„Ø¨Ø§ØªÙ‡ ÙÙ‚Ø· (Ø¹Ø²Ù„ Ø¨Ù€ `userId`)

## ğŸ”’ Ø£Ù…Ø§Ù† Ø§Ù„Ù†Ø¸Ø§Ù…

### Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ù…Ø§ÙŠØ©

1. **Frontend**: Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
2. **Backend**: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ ÙƒÙ„ API
3. **Database**: Views Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„Ø¹Ø²Ù„
4. **Audit**: ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©

### Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø«ØºØ±Ø§Øª

- âœ… Ø¹Ø²Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„ÙØ±ÙˆØ¹ (Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¬Ø§ÙˆØ²Ù‡)
- âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù€ Backend
- âœ… ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
- âœ… Session management Ø¢Ù…Ù†
- âœ… Ù…Ù†Ø¹ SQL Injection (prepared statements)

## ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©

### Database
- `migrations/002_create_branches_and_roles.sql`

### Libraries
- `src/lib/permissions.ts` (500+ Ø£Ø³Ø·Ø±)
- `src/lib/email-error-handler.ts` (700+ Ø£Ø³Ø·Ø±)

### APIs
- `src/pages/api/branches/list.ts`
- `src/pages/api/branches/create.ts`
- `src/pages/api/branches/update.ts`
- `src/pages/api/branches/stats.ts`
- `src/pages/api/users/list.ts`
- `src/pages/api/users/create.ts`
- `src/pages/api/users/update.ts`
- `src/pages/api/roles/list.ts`
- `src/pages/api/email/health.ts`

## âœ… Ø§Ù„Ø®Ù„Ø§ØµØ©

ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¹:
- âœ… 4 Ø£Ø¯ÙˆØ§Ø± Ù…Ø®ØªÙ„ÙØ©
- âœ… Ø¹Ø²Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙˆØ¹
- âœ… 16 ØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙƒÙˆÙŠÙ†
- âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
- âœ… Ø³Ø¬Ù„ ØªØ¯Ù‚ÙŠÙ‚ ÙƒØ§Ù…Ù„
- âœ… 9 APIs Ø¬Ø¯ÙŠØ¯Ø©

**Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:**
1. ØªØ·Ø¨ÙŠÙ‚ Migrations
2. ØªØ­Ø¯ÙŠØ« APIs Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
3. Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (branches.astro, users.astro)
